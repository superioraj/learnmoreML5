<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HandPose Control Example</title>
  <!-- Load p5.js and ml5.js libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ml5/0.12.2/ml5.min.js"></script>
  <style>
    /* Overall page styling using a monospaced (ASCII) font */
    body {
      margin: 0;
      font-family: "Courier New", Courier, monospace;
      background-color: #ffffff;
      color: #333;
      text-align: center;
    }
    /* Navigation bar with Gates Notes style: black background, centered menu */
    .navbar {
      background-color: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0 20px;
      height: 60px;
    }
    .navbar ul {
      list-style: none;
      display: flex;
      margin: 0;
      padding: 0;
    }
    .navbar li {
      margin: 0 25px;
    }
    /* Menu link styling: text-based color changes only */
    .menu-item {
      text-decoration: none;
      font-size: 18px;
      color: #ccc; /* Inactive link color */
      transition: color 0.3s ease;
    }
    .menu-item.active {
      color: #fff; /* Active link color */
    }
    .menu-item:hover {
      color: #eee; /* Hover effect color */
    }
    /* Optional ASCII Typewriter effect container */
    .typewriter-container {
      margin: 40px auto 20px auto;
      max-width: 700px;
      border: 1px dotted #B3B3B3;
      padding: 20px;
      position: relative;
      white-space: pre;
      overflow: hidden;
    }
    .typewriter-container::after {
      content: '|';
      position: absolute;
      right: 20px;
      bottom: 20px;
      font-weight: bold;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0; }
      100% { opacity: 1; }
    }
    /* Table styling: horizontal borders only */
    table {
      margin: 20px auto;
      border-collapse: collapse;
      font-size: 15px;
      width: 70%;
      max-width: 600px;
    }
    th, td {
      border-top: 1px solid #B3B3B3;
      border-bottom: 1px solid #B3B3B3;
      padding: 10px;
    }
    th {
      background-color: #f2f2f2;
    }
    /* Serial connection button */
    #connect {
      margin: 15px;
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
      border: 1px solid #B3B3B3;
      background-color: #fff;
    }
    /* p5.js canvas container */
    #p5-canvas-container {
      margin: 0 auto 30px auto;
      width: 640px;
      position: relative;
      border: 1px solid #B3B3B3;
    }
    /* Gesture text label */
    .gesture-label {
      position: absolute;
      bottom: 10px;
      left: 10px;
      color: red;
      font-size: 24px;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <!-- Navigation bar -->
  <div class="navbar">
    <ul>
      <li><a href="index.html" class="menu-item">Index</a></li>
      <li><a href="HandPose.html" class="menu-item active">HandPose</a></li>
      <li><a href="BodyPose.html" class="menu-item">BodyPose</a></li>
      <li><a href="FaceMesh.html" class="menu-item">FaceMesh</a></li>
    </ul>
  </div>
  
  <!-- Optional ASCII Typewriter effect container -->
  <div id="typewriter" class="typewriter-container"></div>
  
  <!-- Gesture Mapping Table -->
  <table>
    <thead>
      <tr>
        <th>Hand Gesture</th>
        <th>Transmission Character</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Right index finger pointing left</td>
        <td>1</td>
      </tr>
      <tr>
        <td>Right index finger pointing right</td>
        <td>2</td>
      </tr>
      <tr>
        <td>Right index finger pointing up</td>
        <td>3</td>
      </tr>
      <tr>
        <td>Right index finger pointing down</td>
        <td>4</td>
      </tr>
      <tr>
        <td>Right hand open</td>
        <td>5</td>
      </tr>
      <tr>
        <td>Right hand in fist</td>
        <td>6</td>
      </tr>
    </tbody>
  </table>
  
  <!-- Serial connection button -->
  <button id="connect">Connect Serial</button>
  
  <!-- p5.js canvas container -->
  <div id="p5-canvas-container"></div>
  
  <script>
    /************************************************************
     * 1) ASCII Typewriter Effect (Looping) - (Optional)
     ************************************************************/
    const asciiArtText = "| L | E | A | R | N | M | O | R | E |";
    const typeSpeed = 50;   // 50ms per character
    const loopDelay = 2000; // 2 seconds delay before repeating
    
    function startTypewriter() {
      const container = document.getElementById("typewriter");
      let idx = 0;
      function typeChar() {
        if (idx < asciiArtText.length) {
          container.textContent += asciiArtText.charAt(idx);
          idx++;
          setTimeout(typeChar, typeSpeed);
        } else {
          setTimeout(() => {
            container.textContent = "";
            idx = 0;
            typeChar();
          }, loopDelay);
        }
      }
      typeChar();
    }
    document.addEventListener("DOMContentLoaded", startTypewriter);
    
    /************************************************************
     * 2) Handpose + Web Serial API for micro:bit Control
     ************************************************************/
    let video, handpose, predictions = [];
    let port, writer;
    let currentGesture = "";
    
    function setup() {
      let cnv = createCanvas(640, 480);
      cnv.parent('p5-canvas-container');
      
      video = createCapture(VIDEO);
      video.size(width, height);
      video.hide();
      
      handpose = ml5.handpose(video, modelReady);
      handpose.on("predict", results => { predictions = results; });
      
      document.getElementById("connect").addEventListener("click", async () => {
        try {
          port = await navigator.serial.requestPort();
          await port.open({ baudRate: 9600 });
          writer = port.writable.getWriter();
          console.log("Serial Port Connected");
        } catch (error) {
          console.error("Serial Port Connection Error:", error);
        }
      });
    }
    
    function modelReady() {
      console.log("Handpose Model Loaded");
    }
    
    function draw() {
      image(video, 0, 0, width, height);
      if (predictions.length > 0) {
        let hand = predictions[0].landmarks;
        let gesture = detectGesture(hand);
        fill(255, 0, 0);
        textSize(32);
        text("Gesture: " + gesture, 10, height - 10);
        if (gesture && gesture !== currentGesture) {
          currentGesture = gesture;
          sendSerial(gesture);
        }
        drawKeypoints(hand);
      }
    }
    
    function drawKeypoints(landmarks) {
      for (let i = 0; i < landmarks.length; i++) {
        let x = landmarks[i][0], y = landmarks[i][1];
        fill(0, 255, 0);
        noStroke();
        ellipse(x, y, 8, 8);
      }
    }
    
    // Simple gesture detection logic for the right hand:
    // 1 = left, 2 = right, 3 = up, 4 = down, 5 = open, 6 = fist
    function detectGesture(landmarks) {
      let d_index  = dist(landmarks[0][0], landmarks[0][1], landmarks[8][0], landmarks[8][1]);
      let d_middle = dist(landmarks[0][0], landmarks[0][1], landmarks[12][0], landmarks[12][1]);
      let d_ring   = dist(landmarks[0][0], landmarks[0][1], landmarks[16][0], landmarks[16][1]);
      let d_pinky  = dist(landmarks[0][0], landmarks[0][1], landmarks[20][0], landmarks[20][1]);
      let avgOther = (d_middle + d_ring + d_pinky) / 3;
      let xs = landmarks.map(p => p[0]);
      let ys = landmarks.map(p => p[1]);
      let handSize = Math.max(Math.max(...xs) - Math.min(...xs), Math.max(...ys) - Math.min(...ys));
      let avgDistance = (d_index + d_middle + d_ring + d_pinky) / 4;
      if (d_index > avgOther * 1.2) {
        let dx = landmarks[8][0] - landmarks[5][0];
        let dy = landmarks[8][1] - landmarks[5][1];
        if (Math.abs(dx) > Math.abs(dy)) {
          return (dx < 0) ? "1" : "2";
        } else {
          return (dy < 0) ? "3" : "4";
        }
      }
      if (avgDistance > handSize * 0.6) { return "5"; }
      if (avgDistance < handSize * 0.3) { return "6"; }
      return "";
    }
    
    async function sendSerial(command) {
      if (writer) {
        try {
          const data = new TextEncoder().encode(command);
          await writer.write(data);
          console.log("Command Sent: " + command);
        } catch (error) {
          console.error("Serial Send Error:", error);
        }
      }
    }
  </script>
</body>
</html>
